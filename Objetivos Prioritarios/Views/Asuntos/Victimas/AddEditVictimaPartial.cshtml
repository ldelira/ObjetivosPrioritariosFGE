@model Objetivos_Prioritarios.Models.tb_Victimas

<div class="modal-header">
    <h5 class="modal-title">
        @(Model.int_id_victima > 0 ? "Editar Víctima" : "Agregar Víctima")
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    <form id="formVictima" enctype="multipart/form-data">
        @Html.HiddenFor(m => m.int_id_victima)

        <div class="row">
            <!-- Columna izquierda: datos personales -->
            <div class="col-md-8">
                <div class="mb-3">
                    <label class="form-label">Nombre:</label>
                    @Html.TextBoxFor(m => m.nvarchar_nombre, new { @class = "form-control", placeholder = "Nombre" })
                </div>

                <div class="mb-3">
                    <label class="form-label">Apellido Paterno:</label>
                    @Html.TextBoxFor(m => m.nvarchar_paterno, new { @class = "form-control", placeholder = "Apellido paterno" })
                </div>

                <div class="mb-3">
                    <label class="form-label">Apellido Materno:</label>
                    @Html.TextBoxFor(m => m.nvarchar_materno, new { @class = "form-control", placeholder = "Apellido materno" })
                </div>
            </div>

            <!-- Columna derecha: imagen -->
            <div class="col-md-4 text-center">
                <label class="form-label d-block">Foto:</label>

                <!-- Contenedor de vista previa -->
                <div id="previewContainer"
                     class="mt-3"
                     style="display:@(Model != null && !string.IsNullOrEmpty(Model.nvarchar_foto) ? "flex" : "none");
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;">

                    <div style="width: 180px; height: 180px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    overflow: hidden;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background-color: #f8f9fa;">
                        <img id="previewImage"
                             src="@(string.IsNullOrEmpty(Model?.nvarchar_foto) ? "" : "data:image/jpg;base64," + Model.nvarchar_foto)"
                             class="img-thumbnail shadow-sm"
                             style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                    </div>

                    <button type="button" id="removeImage" class="btn btn-danger btn-sm mt-2">Quitar imagen</button>
                </div>

                <!-- Input para subir nueva imagen -->
                <div class="mt-3">
                    <label for="fotoInput" class="form-label">Seleccionar fotografía</label>
                    <input type="file" id="fotoInput" name="foto" accept="image/*" class="form-control" />
                </div>

                @Html.HiddenFor(m => m.nvarchar_foto, new { id = "hiddenFoto" })

                <small class="text-muted d-block mt-2">
                    Puedes subir una nueva foto o mantener la actual.
                </small>
            </div>

            @section Scripts {
                <script>
                    // Mostrar vista previa al seleccionar imagen
                    document.getElementById('fotoInput').addEventListener('change', function (event) {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                const previewContainer = document.getElementById('previewContainer');
                                const previewImage = document.getElementById('previewImage');
                                const hiddenFoto = document.getElementById('hiddenFoto');

                                // Asigna imagen al preview y muestra el contenedor
                                previewImage.src = e.target.result;
                                previewContainer.style.display = 'flex';

                                // Guarda la imagen en Base64 sin el encabezado "data:image..."
                                hiddenFoto.value = e.target.result.split(',')[1];
                            };
                            reader.readAsDataURL(file);
                        }
                    });

                    // Quitar imagen
                    document.getElementById('removeImage').addEventListener('click', function () {
                        const previewImage = document.getElementById('previewImage');
                        const previewContainer = document.getElementById('previewContainer');
                        const fotoInput = document.getElementById('fotoInput');
                        const hiddenFoto = document.getElementById('hiddenFoto');

                        previewImage.src = '';
                        previewContainer.style.display = 'none';
                        fotoInput.value = '';
                        hiddenFoto.value = '';
                    });
                </script>
            }
        </div>
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
    <button type="button" class="btn btn-primary" id="btnGuardarVictima">Guardar</button>
</div>

<script>

        document.addEventListener("DOMContentLoaded", function () {
            const fotoInput = document.getElementById('fotoInput');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const removeImage = document.getElementById('removeImage');

            // Cuando selecciona archivo
            fotoInput.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImage.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Botón para quitar imagen
            removeImage.addEventListener('click', function () {
                fotoInput.value = "";
                previewImage.src = "";
                previewContainer.style.display = 'none';
            });
        });

    document.getElementById('fotoInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const previewContainer = document.getElementById('previewContainer');
                const previewImage = document.getElementById('previewImage');
                const hiddenFoto = document.getElementById('hiddenFoto');

                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';

                hiddenFoto.value = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }
    });


     $(document).off("click", "#btnGuardarVictima").on("click", "#btnGuardarVictima", function () {
    const form = document.getElementById("formVictima");
    const formData = new FormData(form);
    const fotoInput = document.getElementById("fotoInput") ? document.getElementById("fotoInput").files[0] : null;
    const idllamada = '@ViewBag.llamada';
    const idasunto = '@ViewBag.idasunto';

   

    // si foto existe la anexamos
    if (fotoInput) {
        formData.append("foto", fotoInput);
    }

    formData.append("llamada", idllamada);
    formData.append("asunto", idasunto);
    // siempre manda como string; en el server lo parseamos con TryParse
    formData.append("int_id_victima2", '@(Model.int_id_victima==null?0:Model.int_id_victima)');

         debugger;

    $.ajax({
        url: '/Asuntos/SaveVictima',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            if (response.success) {
                swal({
                    title: "Éxito",
                    text: response.message,
                    type: "success"
                }, function () {
                    refreshListaVictimas(1);
                    $("#ModalGenerico").modal("hide");
                });
            } else {
                swal("Error", response.message, "error");
            }
        },
        error: function (xhr, status, error) {
            swal("Error", "Ocurrió un problema al guardar los datos.", "error");
            console.error(error);
        }
    });
});

</script>
