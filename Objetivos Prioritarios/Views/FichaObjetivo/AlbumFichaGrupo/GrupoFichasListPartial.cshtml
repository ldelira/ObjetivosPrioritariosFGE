@* Partial view: Objetivos Relacionados en el Asunto (ajustada a getListObjetivosRelacionadoAsunto_Result) *@

<div class="row">
    <div class="col-md-2">
        <label class="control-label">Estado:</label>
    </div>
    <div class="col-md-4">
        <select class="form-control" id="estadoObjetivoAsunto">
            <option value="1" id="1" @((bool)ViewBag.Actives ? "selected" : "")>Activo</option>
            <option value="0" id="0" @(!(bool)ViewBag.Actives ? "selected" : "")>Inactivo</option>
        </select>
    </div>
</div>

<br />

<div class="row">
    <table id="listaObjetivosRelacionadosDataTable" class="dataTable table table-striped" style="width:100%"></table>
</div>

<div class="modal fade" id="modalFotoAlbum" tabindex="-1" aria-labelledby="modalFotoTituloAlbum" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalFotoTituloAlbum">Fotografía</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalFotoImagenAlbum" src="" alt="Fotografía" class="img-fluid rounded shadow-sm" style="max-height: 450px;">
            </div>
            <div class="modal-footer">
                <a id="modalDescargarAlbum" href="#" class="btn btn-outline-secondary" style="display:none;">Descargar</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>



<script type="text/javascript">
    $("#closeModal").click(function () {
        $("#modalFotoAsuntoObjetivo").modal('hide');
    });

    $(document).ready(function () {
        FillGridListaObjetivoRelacionado();
    });

    // Cambio de estado (Activo / Inactivo)
    $("#estadoObjetivoAsunto").change(function () {
        var valor = $("#estadoObjetivoAsunto").val();
        if (valor == "1") {
            refreshGrupoList(true);
        } else {
            refreshGrupoList(false);
        }
    });

    // Columnas para DataTable (mapeadas al Result real)
    var objetivoRelacionadoColumns = [
        {
            title: "ID",
            data: "int_id_album_detalle",
            visible: false
        },
        {
            title: "ID Objetivo",
            data: "int_id_ficha_objetivo",
            visible: false
        },
        {
            title: "Nombre",
            data: "Nombres",
            orderable: true,
            render: function (data, type, full) {
                return data || "";
            }
        },
        {
            title: "Aliases",
            data: "Aliases",
            orderable: true,
            render: function (data, type, full) {
                return data || "";
            }
        },
        {
            title: "Grupos",
            data: "GruposDelictivos",
            orderable: true,
            render: function (data, type, full) {
                return data || "";
            }
        },
        {
            title: "Estatus Proceso",
            data: "nvarchar_descripcion_estatus",
            orderable: true,
            render: function (data, type, full) {
                return data || (full.bit_estatus ? "Activo" : "Inactivo");
            }
        },
        {
            title: "Obs",
            data: "nvarchar_observaciones",
            orderable: true,
            render: function (data, type, full) {
                return data || "";
            }
        },
        {
            title: "TieneFoto",
            data: "isFoto",
            orderable: true,
            render: function (data, type, full) {
                return data || "";
            }
        },
        //{
        //    title: "Fotografía",
        //    data: "nvarchar_foto",
        //    orderable: false,
        //    render: function (data, type, full, meta) {
        //        if (data) {
        //            return '<img src="data:image/jpeg;base64,' + data + '" class="img-thumbnail" style="width:60px;height:60px;object-fit:cover;" />';
        //        } else {
        //            return '<span class="text-muted">Sin foto</span>';
        //        }
        //    }
        //},

        {
            title: "Acciones",
            data: null,
            orderable: false,
            render: function (data, type, full, meta) {
                var idAlbum = full.int_id_album_detalle;
                var idFicha = full.int_id_ficha_objetivo;

        //        var btnView = `
        //<button class="btn btn-sm btn-primary ver-foto-album"
        //    data-id-album="${idAlbum}"
        //    data-id-ficha="${idFicha}"
        //    title="Ver Fotografía">
        //    <i class="fa fa-eye"></i>
        //</button>`;
                var btnView = `
                <button class="btn btn-sm btn-primary ver-foto-album"
                    data-id="${idFicha}"
                    title="Ver Fotografía">
                    <i class="fa fa-eye"></i>
                </button>`;


                var btnDelete = `
        <button class="btn btn-sm btn-danger eliminar-objetivo"
            onclick="DisableObjetivoAsunto(${idAlbum})"
            title="Desactivar Objetivo">
            <i class="fa fa-trash"></i>
        </button>`;

                var btnActivate = `
        <button class="btn btn-sm btn-success activar-objetivo"
            onclick="ActivateObjetivoAsunto(${idAlbum})"
            title="Activar Objetivo">
            <i class="fa fa-power-off"></i>
        </button>`;

                if ('@ViewBag.Actives'.toUpperCase() === 'TRUE') {
                    return `<div class="btn-group">${btnView}${btnDelete}</div>`;
                } else {
                    return `<div class="btn-group">${btnActivate}</div>`;
                }
            }
        }





    ];



    // Llenar la grilla (llama al action FillObjetivoRelacionadoAsuntoList)
    function FillGridListaObjetivoRelacionado() {

        $.ajax({
            type: 'POST',
            url: '@Url.Action("FillGrupoFichaoList")',
            data: { int_id_album_ficha_objetivo: $("#int_id_album").val(), active: @Html.Raw(Json.Encode(ViewBag.Actives)) },
            success: function (data) {
                $('#listaObjetivosRelacionadosDataTable').DataTable({
                    destroy: true,
                    searching: true,
                    responsive: true,
                    scrollX: true,
                    data: data,
                    columns: objetivoRelacionadoColumns,
                    language: {
                        "sProcessing": "Procesando...",
                        "sLengthMenu": "Mostrar _MENU_ registros",
                        "sZeroRecords": "No se encontraron resultados",
                        "sEmptyTable": "Ningún dato disponible en esta tabla",
                        "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                        "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                        "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                        "sSearch": "Buscar:",
                        "sLoadingRecords": "Cargando...",
                        "oPaginate": {
                            "sFirst": "Primero",
                            "sLast": "Último",
                            "sNext": "Siguiente",
                            "sPrevious": "Anterior"
                        }
                    }
                });
            },
            error: function (xhr, status, error) {
                console.error("Error al llenar la lista de Objetivos relacionados:", error);
            }
        });
    }

    // Función para refrescar (con parámetro opcional)
    function refreshObjetivosRelacionadosList(active) {
        if (typeof active === "undefined") {
            active = ($("#estadoObjetivoAsunto").val() == "1");
        }


        $.ajax({
            type: 'POST',
            url: '@Url.Action("FillGrupoFichaoList")',
            data: { int_id_asunto_relacionado: $("#int_id_asunto_relacionado").val(), active: active },
            success: function (data) {
                var table = $('#listaObjetivosRelacionadosDataTable').DataTable();
                table.clear();
                table.rows.add(data);
                table.draw();
            },
            error: function (xhr, status, error) {
                console.error("Error al refrescar la lista:", error);
            }
        });
    }

    // Desactivar objetivo (llama a DisableObjetivoAsunto)
    function DisableObjetivoAsunto(id) {
        debugger;
        $.ajax({
            type: 'POST',
            url: '@Url.Action("DisableObjetivoGrupo")',
            data: { int_id_album_detalle: id },
            success: function (data) {
                if (data.IsSuccess) {
                    swal({
                        title: "",
                        text: data.Message,
                        type: 'success',
                        confirmButtonText: "Continuar",
                        closeOnConfirm: true,
                    }, function (isConfirm) {
                        if (isConfirm) {
                            swal.close();
                            refreshGrupoList();
                        }
                    });
                } else {
                    swal({
                        title: "Error",
                        text: data.Message || "No tienes permisos para esta acción.",
                        type: 'error'
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error("Error al desactivar objetivo:", error);
            }
        });
    }

    // Activar objetivo (llama a ActivateObjetivoAsunto)
    function ActivateObjetivoAsunto(id) {
        $.ajax({
            type: 'POST',
            url: '@Url.Action("ActivateObjetivoGrupo")',
            data: { int_id_album_detalle: id },
            success: function (data) {
                if (data.IsSuccess) {
                    swal({
                        title: "",
                        text: data.Message,
                        type: 'success',
                        confirmButtonText: "Continuar",
                        closeOnConfirm: true,
                    }, function () {
                        swal.close();
                        refreshGrupoList();
                    });
                } else {
                    swal({
                        title: "Error",
                        text: data.Message || "No tienes permisos para esta acción.",
                        type: 'error'
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error("Error al activar objetivo:", error);
            }
        });
    }


    // click handler para ver la foto en el modal #modalFotoAsuntoObjetivo

    $(document).on('click', '.ver-foto-album', function (e) {
        debugger;
    e.preventDefault();

    var id = $(this).data('id');

    // Muestra el modal de inmediato
    $('#modalFotoTituloAlbum').text('Cargando...');
    $('#modalFotoImagenAlbum').attr('src', '');
    $('#modalDescargarAlbum').hide();

    var modal = new bootstrap.Modal(document.getElementById('modalFotoAlbum'));
    modal.show();

    // Llamada AJAX al controlador
    $.ajax({
        url: '@Url.Action("GetFotoAjax", "Asuntos")',
        method: 'POST',
        dataType: 'json',
        data: { id: id },
        success: function (resp) {
            if (resp.success && resp.foto) {
                var foto = resp.foto;
                var src = (foto.indexOf('data:image') === 0)
                    ? foto
                    : ('data:image/jpeg;base64,' + foto);

                $('#modalFotoTituloAlbum').text('Fotografía del registro');
                $('#modalFotoImagenAlbum').attr('src', src);

                if ($('#modalDescargarAlbum').length) {
                    $('#modalDescargarAlbum').attr('href', src);
                    $('#modalDescargarAlbum').attr('download', 'foto_' + id + '.jpg');
                    $('#modalDescargarAlbum').show();
                }
            } else {
                $('#modalFotoTituloAlbum').text(resp.message || 'Sin fotografía disponible');
                $('#modalFotoImagenAlbum').attr('src', '');
                $('#modalDescargarAlbum').hide();
            }
        },
        error: function (xhr, status, err) {
            console.error('Error al obtener foto:', err);
            $('#modalFotoTituloAlbum').text('Error al cargar la imagen');
            $('#modalFotoImagenAlbum').attr('src', '');
        }
    });
});

</script>
